---

- name: Create LXC Container
  run_once: true
  delegate_to: localhost
  block:
    - name: Get all defined hosts
      ansible.builtin.find:
        paths: "./host_vars"
        patterns: "*.yml"
      register: defined_hosts

    - name: Get vars from file
      ansible.builtin.set_fact:
        host_vars_list: "{{ host_vars_list | default([]) + [lookup('ansible.builtin.file', item.path) | from_yaml] }}"
      loop: "{{ defined_hosts.files }}"

    - name: Debug
      ansible.builtin.debug:
        var: host_vars_list

    - name: Create missing LXC container
      community.general.proxmox:
        api_host: '{{ pve_api_host }}'
        api_port: '{{ pve_api_port }}'
        api_user: '{{ pve_apiuser }}'
        api_password: '{{ pve_root_password }}'
        state: 'present'

        cores: '{{ item.lxc_data.cores | default(pve_lxc_defaults.cores) }}'
        description: '{{ item.lxc_data.description | default(pve_lxc_defaults.description) }}'
        disk: '{{ item.lxc_data.disk | default(pve_lxc_defaults.disk) }}'
        features: '{{ item.lxc_data.features | default(pve_lxc_defaults.features) }}'
        force: '{{ item.lxc_data.force | default(pve_lxc_defaults.force) }}'
        hostname: '{{ item.host_name }}'
        memory: '{{ item.lxc_data.memory | default(pve_lxc_defaults.memory.ct) }}'
        netif: '{{ item.lxc_data.netif | default(pve_lxc_defaults.netif) }}'
        node: '{{ item.lxc_data.node | default(pve_lxc_defaults.node) }}'
        onboot: '{{ item.lxc_data.onboot | default(pve_lxc_defaults.onboot) }}'
        ostemplate: '{{ item.lxc_data.ostemplate | default(pve_lxc_defaults.ostemplate) }}'
        password: '{{ item.lxc_data.password | default(pve_lxc_defaults.password) }}'
        swap: '{{ item.lxc_data.swap | default(pve_lxc_defaults.swap) }}'
        tags: '{{ item.lxc_data.tags | default(pve_lxc_defaults.tags) }}'
        vmid: '{{ item.lxc_data.vmid | default(pve_lxc_defaults.vmid) }}'
      loop: '{{ host_vars_list }}'
      timeout: 60
      loop_control:
        label: "{{ item.host_name }}"
        pause: 2
      notify:
        - Sleep
      register: 'created_lxc_container'
      when: 'item.host_name not in groups["proxmox_all_lxc"]'

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: Set facts
      ansible.builtin.set_fact:
        created_hosts: '{{ created_hosts | combine({item.item.key: {"node": item.item.value.node, "vmid": item.item.value.vmid}}) }}'
      with_items: '{{ created_lxc_container.results }}'
      when: item.changed # noqa: no-handler

    - name: Start container
      community.general.proxmox:
        api_host: '{{ pve_api_host }}'
        api_port: '{{ pve_api_port }}'
        api_user: '{{ pve_apiuser }}'
        api_password: '{{ pve_root_password }}'

        node: '{{ item.value.node | default(pve_lxc_defaults.node) }}'
        hostname: '{{ item.key }}'
        state: started
      with_dict: '{{ created_hosts }}'
      notify:
        - Sleep

    - name: Enable root ssh in container
      ansible.builtin.include_tasks: configure_lxc.yml
      vars:
        lxc_node: '{{ item.value.node }}'
        lxc_id: '{{ item.value.vmid }}'
      with_dict: '{{ created_hosts }}'
