#!/bin/bash
set -euo pipefail

# Hub-Config laden
if [ -f /root/unattended.conf ]; then
  # shellcheck disable=SC1091
  source /root/unattended.conf
fi

: "${HUB_URL:?HUB_URL is not set}"          # z.B. http://notification-hub:8080
: "${HUB_TOKEN:?HUB_TOKEN is not set}"      # Ingress-Secret
: "${HUB_SLUG:=unattended}"                 # Ingress-Slug (default)

STATUS="${1:-unknown}"
HOSTNAME="$(hostname)"
TS="$(date -Is)"

LOG_FILE="/var/log/unattended-upgrades/unattended-upgrades.log"
TMP_LOG="$(mktemp)"

if [ -r "$LOG_FILE" ]; then
  tail -n 40 "$LOG_FILE" \
    | perl -pe 's/[[:cntrl:]&&[^\t\n\r]]/?/g' \
    | tail -c 900 > "$TMP_LOG"
else
  printf '%s' "(kein Logfile lesbar: %s)" "$LOG_FILE" > "$TMP_LOG"
fi

if [ "$STATUS" = "success" ]; then
  SEVERITY="success"
  TITLE="Unattended Upgrades erfolgreich"
else
  SEVERITY="error"
  TITLE="Unattended Upgrades FEHLER"
fi

PAYLOAD="$(
  jq -n \
    --rawfile log "$TMP_LOG" \
    --arg title "$TITLE" \
    --arg host "$HOSTNAME" \
    --arg time "$TS" \
    --arg status "$STATUS" \
    --arg severity "$SEVERITY" \
    '{
      source: "unattended",
      event: "unattended.upgrades",
      severity: $severity,
      title: $title,
      entities: {host: $host, time: $time, status: $status, log: $log}
    }'
)"

HTTP_CODE="$(curl -sS -o /tmp/hub_resp.txt -w "%{http_code}" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $HUB_TOKEN" \
  -X POST \
  --data "$PAYLOAD" \
  "$HUB_URL/ingest/$HUB_SLUG" || echo "curl_failed")"

if [ "$HTTP_CODE" != "204" ]; then
  echo "Hub ingest failed: http=$HTTP_CODE body=$(cat /tmp/hub_resp.txt)" >&2
  exit 1
fi
rm -f "$TMP_LOG"